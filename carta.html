<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Parisienne&display=swap" rel="stylesheet">

<title>Carta animada</title>
<style>
  :root{
    --bg:#f6f7fb;
    --envelope:#e74c3c;
    --paper:#fff;
    --text:#222;
    --shadow: rgba(0,0,0,0.12);
  }
  html,body{height:100%;margin:0; font-family: Quicksand, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  body{
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;

    /* Fondo animado */
    background: linear-gradient(120deg, #ffe7ec, #eef2ff, #e7fff4);
    background-size: 300% 300%;
    animation: bgShift 18s ease infinite;
  }
  @keyframes bgShift{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }

  .stage{
    position:relative;           /* para posicionar el bot√≥n encima de la carta */
    width:min(92vw,460px);
    perspective:1000px;
    text-align:center;
  }

  /* Mantener proporci√≥n en todos los dispositivos */
  .envelope{
    position:relative;
    width:100%;
    aspect-ratio: 16 / 10;
    transform-style:preserve-3d;
  }

  .env-body{
    position:absolute;
    inset:0;
    background:var(--envelope);
    border-radius:10px;
    box-shadow:0 12px 30px var(--shadow), inset 0 -6px rgba(0,0,0,0.08);
    overflow:visible;
    z-index:1;
  }

  .env-flap{
    position:absolute;
    left:0; right:0; top:0;
    height:50%;
    background:linear-gradient(180deg,#ff6b6b,var(--envelope));
    transform-origin:top center;
    transform:rotateX(0deg) translateZ(0);
    border-bottom-left-radius:10px;
    border-bottom-right-radius:10px;
    box-shadow:0 8px 18px rgba(0,0,0,0.14);
    z-index:3;
    backface-visibility:hidden;
    will-change: transform;
  }
  .env-flap:before{
    content:"";
    position:absolute;
    left:50%; top:50%;
    width:210%; height:210%;
    background:rgba(255,255,255,0.06);
    transform:translate(-50%,-50%) rotate(45deg);
    filter:blur(2px);
    opacity:0.08;
    pointer-events:none;
  }

  .letter{
    position:absolute;
    left:8%; right:8%;
    top:24%; bottom:8%;
    background:var(--paper);
    border-radius:8px;
    box-shadow:0 8px 20px rgba(0,0,0,0.12);
    transform-origin:top center;
    transform:translateY(0) scale(0.98) translateZ(0);
    z-index:2;
    padding:28px 20px;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    overflow:hidden;
    will-change: transform;
    background:
      repeating-linear-gradient(0deg, rgba(0,0,0,.03) 0 1px, transparent 1px 28px),
      radial-gradient(120% 100% at 50% 0%, #ffffff, #fafbff);
  }

  .paper-lines{
    width:100%;
    height:100%;
    color:var(--text);
    font-size:16px;
    line-height:1.4;
  }

  /* Animaciones */
  @keyframes flapOpen {
    0% { transform: rotateX(0deg) translateZ(0); }
    60% { transform: rotateX(-100deg) translateZ(0); }
    100% { transform: rotateX(-120deg) translateZ(0); }
  }
  @keyframes letterRise {
    0% { transform: translateY(0) scale(0.98) translateZ(0); }
    60% { transform: translateY(-24%) scale(1.00) translateZ(0); }
    100% { transform: translateY(-40%) scale(1.02) translateZ(0); }
  }

  .animate .env-flap{
    animation: flapOpen 1.1s ease-in-out forwards;
  }
  .animate .letter{
    animation: letterRise 0.9s ease-in-out 0.6s forwards;
  }

  .message-wrap{
    margin-top:16px;
    min-height:120px;
  }
  .message{
    white-space:pre-wrap;
    font-size:16px;
    color:var(--text);
    opacity:0;
    transition:opacity .35s ease .05s;
  }
  .show-message .message{ opacity:1; }

  .typed-cursor{
    display:inline-block;
    width:10px;
    background:var(--text);
    margin-left:4px;
    animation: blink 1s steps(1) infinite;
    vertical-align:bottom;
    height:1em;
  }
  @keyframes blink { 50% { opacity:0 } }

  /* Bot√≥n de m√∫sica centrado encima de la carta */
  .musicBtn{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    border:0;
    padding:16px 18px;
    font-size:24px;
    border-radius:50%;
    background:#fff;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,0.25);
    z-index:20;
    transition:opacity .4s ease, transform .2s ease;
    opacity:1;
  }
  .musicBtn:hover{ transform:translate(-50%, -50%) scale(1.1); }

  /* Oculto inicialmente hasta que termine el texto */
  .hidden{ opacity:0; pointer-events:none; }

  /* M√≥vil vertical */
  @media (max-width:480px){
    .stage{ width:min(94vw,420px); }
    .letter{ padding:20px 14px; }
    .paper-lines{ font-size:14px; }
  }
</style>
</head>
<body>
  <div class="stage">
    <div id="envelope" class="envelope">
      <div class="env-body"></div>
      <div class="env-flap"></div>
      <div class="letter">
        <div class="paper-lines"><span id="typed"></span><span id="cursor" class="typed-cursor"></span></div>
      </div>
    </div>

    <div class="message-wrap" id="messageWrap" aria-live="polite"></div>

    <!-- Bot√≥n de m√∫sica (inicialmente oculto) + audio -->
    <button id="musicBtn" class="musicBtn hidden" aria-label="Reproducir m√∫sica" title="M√∫sica">üé∂</button>
    <audio id="bgm" src="dos.mp3" preload="auto" loop></audio>
  </div>

<script>
  const message = `Buenoooos Diaaaas :)

Muchissiisisma suerte en tu dia, en tus clases, en tu trabajo,
yendo a las maquinitas, con tus amigos, peleando con profes, en
todo que te vaya requetebien                            


üåüLindo dia hoy y siempre üåü

No se te olvide siempre apreciar todo todito
Siempre bailando por la vida.
`;

  const envelope = document.getElementById('envelope');
  const typedSpan = document.getElementById('typed');
  const cursor = document.getElementById('cursor');
  const messageWrap = document.getElementById('messageWrap');

  function typeIn(element, text, speed = 20, done){
    typedSpan.textContent = '';
    let i = 0;
    function step(){
      if(i <= text.length){
        typedSpan.textContent = text.slice(0, i);
        if(i === text.length){
          cursor.style.display = 'none';
          if(done) done();
          return;
        }
        i++;
        setTimeout(step, speed);
      }
    }
    step();
  }

  function revealMessageOutside(text){
    messageWrap.innerHTML = `<div class="message">${text}</div>`;
    setTimeout(()=> messageWrap.classList.add('show-message'), 150);

    // Mostrar el bot√≥n de m√∫sica cuando termina el texto
    const musicBtn = document.getElementById('musicBtn');
    musicBtn.classList.remove('hidden');
  }

  function openLetter(){
    // Forzar un reflow antes de a√±adir la clase (asegura que la animaci√≥n siempre arranque)
    envelope.offsetHeight;
    envelope.classList.add('animate');
    // Iniciar tipiado cuando la carta ya ‚Äúsali√≥‚Äù
    setTimeout(()=>{
      typeIn(typedSpan, message, 20, ()=> revealMessageOutside(message));
    }, 1700);
  }

  // Disparo robusto: DOM listo -> rAF -> timeout
  document.addEventListener('DOMContentLoaded', () => {
    requestAnimationFrame(() => {
      setTimeout(openLetter, 400);
    });
  });

  // Accesibilidad: si el usuario prefiere reducir movimiento, salta animaciones
  const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
  if (mq.matches) {
    envelope.classList.add('animate');
    typeIn(typedSpan, message, 0, ()=> revealMessageOutside(message));
  }

  /* ====== Control de m√∫sica ====== */
  (function music(){
    const btn = document.getElementById('musicBtn');
    const audio = document.getElementById('bgm');
    if(!btn || !audio) return;

    let playing = false;

    btn.addEventListener('click', async ()=>{
      try{
        if(!playing){
          await audio.play();        // requiere interacci√≥n del usuario (este click)
          playing = true;
          btn.textContent = '‚è∏Ô∏è';    // cambia a icono de pausa
          btn.setAttribute('aria-label','Pausar m√∫sica');
          btn.title = 'Pausar';
        } else {
          audio.pause();
          playing = false;
          btn.textContent = 'üé∂';    // icono de m√∫sica
          btn.setAttribute('aria-label','Reproducir m√∫sica');
          btn.title = 'M√∫sica';
        }
      }catch(e){
        console.log("Error al reproducir m√∫sica:", e);
      }
    });
  })();
</script>
</body>
</html>
